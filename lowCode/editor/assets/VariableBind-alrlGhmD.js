import{r as x,a as C,K as T,dl as A,j as e,ag as M,P as E,B as y}from"./index-DmOc0qNU.js";import{V as D}from"./VsEditor-DbAzcx7k.js";import{F}from"./index-1_6nT-oA.js";import{M as P}from"./index-_pMv_sKm.js";import{a as O}from"./NotificationOutlined-DlRBMYlM.js";import{R as w}from"./QuestionCircleOutlined-Dza1yYuv.js";import{T as L}from"./index-B6d_3ZHh.js";import{R as B}from"./DownOutlined-DnWdyoG8.js";import{I as W}from"./index-B-YUPJxN.js";import{R as K}from"./FunctionOutlined-Dm0pzJNb.js";const G="_container_1c6k4_1",H="_leftFn_1c6k4_6",q="_box_1c6k4_23",z="_content_1c6k4_27",J="_title_1c6k4_30",Q="_variable_1c6k4_38",p={container:G,leftFn:H,box:q,content:z,title:J,variable:Q},U=({onSelect:m},h)=>{const[j,u]=x.useState(!1),[s]=F.useForm(),{variables:g,pageName:a,elements:i,elementsMap:d}=C(r=>({variables:r.page.pageData.variables,pageName:r.page.name,elements:r.page.pageData.elements,elementsMap:r.page.pageData.elementsMap})),v=x.useCallback(()=>{const r=[];return Object.keys(d).map(t=>{var o;if(t.startsWith("SearchForm_")||t.startsWith("Form_")||t.startsWith("GridForm_")||t.startsWith("MarsTable_")){const{element:l}=T(A(i),t);if(!l)return;(o=l.elements)==null||o.map(c=>{var f;const n=(f=d[c.id])==null?void 0:f.config.props.formItem;n?c.name=`${n.label}(${n.name})`:c.name=""}),l.elements&&(l.elements=l.elements.filter(c=>c.name)),r.push(l)}}),r},[d,i]),S=[{name:`页面【${a}】`,id:"page",elements:[{name:"系统变量",id:"SystemVariable",type:"SystemVariable",elements:[{type:"Store",id:"userId",name:"userId"},{type:"Store",id:"nickName",name:"nickName"},{type:"Store",id:"userName",name:"userName"}]},{name:"全局变量",id:"PageVariable",type:"PageVariable",elements:V(g)},...v()]}];function V(r){return r.map(t=>{const{name:o,type:l,defaultValue:c}=t,n={name:o,value:c,elements:[]};return l==="array"?(n.type="Variable",n.id=t.name,n.name=`Array<${t.name}>${t.remark?"("+t.remark+")":""}`):l==="object"?(n.id=t.name,n.name=`${t.name}${t.remark?"("+t.remark+")":""}`,n.type="Variable",n.elements=V(Object.entries(c).map(([f,k])=>({type:Array.isArray(k)?"array":typeof k,id:t.name+"."+f,name:t.name+"."+f,defaultValue:k})))):(n.type="Variable",n.id=t.name,n.name=`${t.name}${t.remark?"("+t.remark+")":""}`),n})}x.useImperativeHandle(h,()=>({open(r){s.setFieldValue("expression",r),u(!0)}}));const b=r=>{r==="boolean"&&s.setFieldValue("expression","true"),r==="table"?s.setFieldValue("expression",`function render(text, record, index) {
    return text;
}`):r==="expression"?s.setFieldValue("expression","status === 1 ? '启用' : '禁用'"):r==="function"&&s.setFieldValue("expression",`function run() {
    return context.eventParams;
}`)},_=(r,{node:t})=>{var l,c;if(!t.type)return;const o=s.getFieldValue("expression")??"";if(t.type==="Store"){s.setFieldValue("expression",`${o} context.store.${t.id}`.trimStart());return}if(t.type==="Variable"){s.setFieldValue("expression",`${o} context.variable.${t.id}`.trimStart());return}if(t.type==="PageVariable")s.setFieldValue("expression",`${o} context.variable`);else if(t.type==="EditTable"){const n=(l=d[t.id])==null?void 0:l.config.props.field;n&&s.setFieldValue("expression",`${o} context.${t.parentId}.${n}`.trimStart())}else if(t.type==="Form"||t.type==="SearchForm")s.setFieldValue("expression",`${o}  context.${t.id}`);else{const n=(c=d[t.id])==null?void 0:c.config.props.formItem;s.setFieldValue("expression",`${o} context.${t.parentId}.${n.name}`.trimStart())}},N=r=>{const t=s.getFieldValue("expression")??"";s.setFieldValue("expression",`${t} context.${r}()`.trimStart())},I=()=>{const r=s.getFieldValue("expression");m({value:r}),$()},$=()=>{u(!1)},R=[{key:"1",label:"逻辑函数",children:null},{key:"2",label:"数学函数",children:null},{key:"3",label:"日期函数",children:e.jsx("ul",{children:e.jsx("li",{onClick:()=>N("FORMAT"),children:"FORMAT"})})},{key:"4",label:"数组函数",children:null}];return e.jsxs(P,{open:j,onCancel:$,title:"逻辑编辑器",width:1100,onOk:I,okText:"确认",cancelText:"取消",children:[e.jsxs("div",{style:{marginBlock:10},children:[e.jsx(O,{style:{color:"#7D33FF"}}),e.jsx("span",{style:{marginLeft:5},children:"下表为页面定义的全局变量，选择时，直接鼠标点击对应的行即可。"})]}),e.jsxs("div",{className:p.container,children:[e.jsxs("div",{className:p.leftFn,children:[e.jsx("div",{className:p.title,children:"计算函数"}),e.jsx("div",{className:p.box,children:e.jsx(M,{ghost:!0,items:R,style:{marginTop:-13}})})]}),e.jsxs("div",{className:p.content,children:[e.jsxs("div",{className:p.title,children:["表达式",e.jsx(E,{content:e.jsxs("div",{children:[e.jsx("p",{children:"1. 默认支持普通变量定义，最终会返回该解析后的变量值：variable.current "}),e.jsx("p",{children:"2. 支持三元表达式：userName === 'jack' ? 1 : 2 "}),e.jsx("p",{children:"2. 支持布尔值：true ，最终会被解析会true变量进行返回。"}),e.jsxs("p",{children:["3. 支持逻辑判断：if( a ",">"," 1 ) return 1; return 2 "]}),e.jsxs("p",{children:["4. 支持函数function定义：function getName()",'{ return "jack" } ']}),e.jsx("p",{children:"5. 定义函数的时候，不支持自定义参数，参数只能是从右侧选择的变量或者表单对象，系统会自动解析。"}),e.jsxs("p",{children:["6. 表格自定义渲染时，需要手工定义渲染函数：function render(text, record, index) ","{ return text; }"]})]}),children:e.jsx(w,{style:{marginLeft:10,cursor:"pointer"}})}),e.jsx(y,{type:"link",onClick:()=>b("boolean"),children:"布尔值"}),e.jsx(y,{type:"link",onClick:()=>b("expression"),children:"三元表达式模板"}),e.jsx(y,{type:"link",onClick:()=>b("function"),children:"函数模板"}),e.jsx(y,{type:"link",onClick:()=>b("table"),children:"表格自定义渲染模板"})]}),e.jsx("div",{className:p.formula,children:e.jsx(F,{form:s,children:e.jsx(F.Item,{noStyle:!0,name:"expression",children:e.jsx(D,{height:"440px",language:"javascript"})})})})]}),e.jsxs("div",{className:p.variable,children:[e.jsx("div",{className:p.title,children:"参数和变量"}),e.jsx(L,{showLine:!0,defaultExpandAll:!0,switcherIcon:e.jsx(B,{}),fieldNames:{title:"name",key:"id",children:"elements"},treeData:S,onSelect:_})]})]})]})},X=x.memo(x.forwardRef(U)),oe=({value:m,onChange:h,...j})=>{const u=x.useRef();function s(i){var d;h({type:"static",value:(d=i==null?void 0:i.target)==null?void 0:d.value})}function g(i){h({type:"variable",...i})}const a=typeof m=="string"||typeof m=="number"?{type:"static",value:m}:m;return e.jsxs(e.Fragment,{children:[e.jsx(W,{readOnly:(a==null?void 0:a.type)==="variable"&&a.value,allowClear:!0,value:a==null?void 0:a.value,onChange:s,addonAfter:e.jsx(K,{onClick:()=>{var i;(i=u.current)==null||i.open(a==null?void 0:a.value)},style:{color:(m==null?void 0:m.type)==="variable"?"#7D33FF":""}}),placeholder:"请选择变量",...j}),e.jsx(X,{ref:u,onSelect:g})]})};export{oe as V};
