import{getComponentRef as h}from"./useComponentRefs-BjsmN1lJ.js";import{handleApi as N}from"./handleApi-Bz3x1xZ4.js";import{M,m as j,dj as v,dk as S,a as k}from"./index-CY1Ymj4r.js";import{j as g,k as C,i as L,m as O,n as R,r as b}from"./util-UBnOudtO.js";import d from"./request-K5LtYnQH.js";import"./index-yDMkoRSw.js";import"./_baseGet-C1wBFXxd.js";function y(e,s=!0){var a,r;let i=null,c=null;for(const u of e){if(u.type==="start"||u.type==="end")continue;let f={action:{...u.config}};if(u.type==="condition"){const p=y(((a=u.children.find(o=>o.title==="成功"))==null?void 0:a.children)||[],!0),A=y(((r=u.children.find(o=>o.title==="失败"))==null?void 0:r.children)||[],!1),w=e.slice(e.indexOf(u)+1).filter(o=>o.type!=="end");if(f={success:p,fail:A},!c)i=f;else if(s)if(!c.next)c.next=f;else{let o=c.next;for(;o.next;)o=o.next;o.next=f}else if(!c.fail)c.fail=f;else{let o=c.fail;for(;o.next;)o=o.next;o.next=f}if(c=f,w.length>0){let o=y(w,!0);if(!c.success)c.success=o;else{let t=c.success;for(;t.next;)t=t.next;for(;o.action;)t.next={action:o.action},t=t.next,o=o.next||{}}let m=y(w,!0);if(!c.fail)c.fail=m;else{let t=c.fail;for(;t.next;)t=t.next;for(;m.action;)t.next={action:m.action},t=t.next,m=m.next||{}}}}else if(!c)i=c=f;else if(s)if(!c.next)c.next=f;else{let p=c.next;for(;p.next;)p=p.next;p.next=f}else if(!c.next)c.next=f;else{let p=c.next;for(;p.next;)p=p.next;p.next=f}}return i}function x(e=[],s){const i=y(e);i!=null&&i.action&&l(i,s)}const l=(e,s={})=>{if(!(!e||!(e!=null&&e.action)))try{const i=V(e.action.data,s);delete e.action.data,e.action=g(e.action,s),e.action.actionType==="methods"?n(e,i):e.action.actionType==="showConfirm"?$(e,i):e.action.actionType==="message"?q(e,i):e.action.actionType==="notification"?F(e,i):e.action.actionType==="request"||e.action.actionType==="download"?E(e,i):e.action.actionType==="formReset"?(e.action.method="reset",n(e,i)):e.action.actionType==="formSubmit"?(e.action.method="submit",n(e,i)):e.action.actionType==="formValidate"?(e.action.method="validate",n(e,i)):e.action.actionType==="formAssignment"?(e.action.method="init",n(e,i)):e.action.actionType==="formGetValue"?(e.action.method="getFormData",n(e,i)):["openModal","openDrawer"].includes(e.action.actionType)?T(e,i,"open"):["closeModal","closeDrawer"].includes(e.action.actionType)?T(e,i,"close"):e.action.actionType==="jumpLink"?I(e,i):e.action.actionType==="reloadPage"?window.location.reload():e.action.actionType==="variable"?W(e,i):e.action.actionType==="copy"?B(e,i):e.action.actionType==="setTimeout"?G(e,i):e.action.actionType==="visible"?J(e,i):e.action.actionType==="disable"?U(e,i):e.action.actionType==="sendMessage"?z(e,i):e.action.actionType==="createNode"?H(e,i):e.action.actionType==="script"&&K(e,i)}catch(i){console.error(`事件流[${e.actionType}执行异常]`,i)}},V=(e=[],s={})=>{const i=C(e,s);return!(e!=null&&e.length)&&(Array.isArray(s)||typeof s=="string"||typeof s=="number"||typeof s=="boolean")?s:(s&&Object.keys(s).forEach(c=>{c&&typeof s[c]<"u"&&s[c]!=null&&(i[c]=s[c])}),g(i))};async function n({action:e,next:s},i={}){var a;const c=h(e.target);if(!c){sessionStorage.setItem("mars-event-flow-wait","1"),Number(sessionStorage.getItem("mars-event-flow-wait"))<10?setTimeout(()=>{n({action:e,next:s},i)},100):console.error("组件加载超时，请检查组件是否存在");return}try{const r=await((a=c==null?void 0:c[e.method])==null?void 0:a.call(c,{...e==null?void 0:e.params,...i}));typeof r=="boolean"?l(r?(s==null?void 0:s.success)||s:s==null?void 0:s.fail,i):setTimeout(()=>{(Array.isArray(r)||typeof r!="object")&&L(r)?l((s==null?void 0:s.success)||s,r):l((s==null?void 0:s.success)||s,Object.assign(i,r||{}))})}catch(r){l(s==null?void 0:s.fail,i),console.error(`【${e.method}】方法调用失败：`,r)}}async function T({action:e,next:s},i={},c){const a=h(e.target);c==="close"&&a.close({...i}),c==="open"&&await a.open({...i}),l((s==null?void 0:s.success)||s,i)}const $=({action:e,next:s},i)=>{var c,a;(a=(c=M)[e.type])==null||a.call(c,{title:e.title,content:e.content,okText:e.okText,cancelText:e.cancelText,onOk:()=>{l((s==null?void 0:s.success)||s,i)},onCancel:()=>{l(s==null?void 0:s.fail,i)}})},q=({action:e,next:s},i)=>{j.open({type:e.type,content:e.content,duration:e.duration}).then(()=>{l((s==null?void 0:s.success)||s,i)})},F=({action:e,next:s},i)=>{v.open({type:e.type,message:e.message,description:e.description,placement:e.placement,duration:e.duration}),l((s==null?void 0:s.success)||s,i)},E=async({action:e,next:s},i)=>{const c=await N(e,i);c.code===0?l((s==null?void 0:s.success)||s,c):l(s==null?void 0:s.fail,c)},I=async({action:e,next:s},i)=>{var a;const c=new URLSearchParams(i);if(e.jumpType==="route"){let r=e.url;c&&(r+=e.url.indexOf("?")>-1?"&":"?"+c),S.navigate(r)}else if(e.jumpType==="micro")window.microApp||console.warn("跨服务跳转：当前页面不在微应用环境中，无法跳转"),(a=window.microApp)==null||a.dispatch({type:"router",path:e.url,data:i});else if(e.jumpType==="link"){const r=`${e.url}${e.url.indexOf("?")>-1?"&":"?"}${c}`;e.isNewWindow?window.open(r):window.location.href=r}},W=({action:e,next:s},i)=>{let c=e.assignmentType==="reset"?void 0:i[e.name];e.assignmentType==="reset"?c=void 0:e.assignmentType==="assignment"&&(e.assignmentWay==="static"?c=e.value:c=i),k.getState().setVariableData({name:e.name,value:c}),l((s==null?void 0:s.success)||s,i)},B=async({action:e,next:s},i)=>{try{const c=O(e.content,i||{});await R(c),l((s==null?void 0:s.success)||s,i)}catch(c){console.log("执行复制行为：",c)}},G=async({action:e,next:s},i)=>{setTimeout(()=>{l((s==null?void 0:s.success)||s,i)},e.duration*1e3)},J=async({action:e,next:s},i)=>{const c=h(e.target);e.showType==="static"?e.showResult==="show"?c.show({...i}):c.hide({...i}):e.expression?c.show({...i}):c.hide({...i}),l((s==null?void 0:s.success)||s,i)},U=async({action:e,next:s},i)=>{const c=h(e.target);if(e.disableType==="static")e.disableResult?c.disable({...i}):c.enable({...i});else{const r=(e.expression??{}).value;b(r)?c.disable({...i}):c.enable({...i})}l((s==null?void 0:s.success)||s,i)},z=async({action:e,next:s},i)=>{const c=await d.post("/api/robot/sendMessage",{...e,variables:i});c.data.code===0?l((s==null?void 0:s.success)||s,c.data.data):l(s==null?void 0:s.fail,c.msg)},H=async({action:e,next:s},i)=>{const c=await d.post("/api/robot/createNode",{...e,variables:i});c.data.code===0?l((s==null?void 0:s.success)||s,c.data.data):l(s==null?void 0:s.fail,c.msg)},K=async({action:e,next:s},i)=>{const c=b(e.scripts,i);typeof c=="boolean"?l(c?(s==null?void 0:s.success)||s:s==null?void 0:s.fail,i):l((s==null?void 0:s.success)||s,c??i)};export{x as handleActionFlow};
